# Python package
# Create and test a Python package on multiple Python versions.
# Add steps that analyze code, save the dist with the build record, publish to a PyPI-compatible index, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/python
trigger:
  branches:
    include:
      - dev
  tags:
    include:
      - '*'

pool:
  vmImage: 'windows-latest'

steps:
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.11'  # O la versi贸n que uses

- script: |
    python -m pip install --upgrade pip
    pip install -r requirements.txt
    pip install pyinstaller
  displayName: 'Instalar dependencias'

- script: |
    python calver_increment.py
  displayName: 'Actualizar versi贸n CalVer incremental'

- powershell: |
    $version = Get-Content VERSION | ForEach-Object { $_.Trim() }
    echo "##vso[task.setvariable variable=APP_VERSION]$version"
  displayName: 'Leer versi贸n desde VERSION'

- script: |
    pyinstaller --onefile --windowed --name "Generador Documentos Funcionales-$(APP_VERSION)" --icon=resources/icons/Zoo.ico --add-data "resources;resources" --add-data "app;app" --add-data "gui;gui" --add-data "msedgedriver.exe;." main.py
  displayName: 'Generar .exe con PyInstaller y versi贸n'

- powershell: |
    git fetch origin dev
    git checkout -B dev origin/dev
  displayName: 'Checkout rama dev antes de commit'

- powershell: |
    git config user.email "pipeline@azuredevops"
    git config user.name "Azure DevOps Pipeline"
    git add VERSION
    git commit -m "Actualiza VERSION a $(APP_VERSION) [ci skip]"
    if ($LASTEXITCODE -ne 0) { Write-Host "No hay cambios en VERSION" }
    git push origin dev
  displayName: 'Commit y push de VERSION actualizado'
  condition: succeeded()

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: 'dist'
    ArtifactName: 'exe'
    publishLocation: 'Container'
